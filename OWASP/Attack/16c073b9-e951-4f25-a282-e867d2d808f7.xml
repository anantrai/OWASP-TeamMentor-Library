<?xml version="1.0" encoding="utf-8"?><guidanceItem id="16c073b9-e951-4f25-a282-e867d2d808f7" type="Attack" title="AJAX Injection Attack" cssFile="guidance.css" Date="2010-06-24T20:16:47.77Z" Author="" Category="Input and Data Validation" filePath="..\Libraries\OWASP\Attack\16c073b9-e951-4f25-a282-e867d2d808f7.xml" Priority="1" Rule_Type="Implementation" Source="SI" Status="" Technology=" Any" Topic="Security" Type="Attack" xmlns="urn:microsoft:guidanceexplorer:guidanceItem"><content><![CDATA[<BR><BR><H1>Applies To</H1><P>Web Applications that use an AJAX implementation</P><H1>Description</H1><P>AJAX (Asynchronous Javascript and XML) technology allows web pages to dynamically update specific content behind the scenes without the need to refresh the whole page. The ability to continually update the content of an AJAX page is done by calling an XmlHttpRequest (XHR) object with JavaScript to send HTTP requests to web servers. These requests typically send data in the form of XML or JSON (JavaScript Object Notation). </P><P>AJAX injection is a type of <A href="ruledisplay:BC10DCE2-CA48-44BF-8BF6-FEFBE8DCCB7E">Cross Site Scripting Attack</A> (XSS) that leverages the XML or JSON format of the input to the client browser. JSON is particularly popular because it is easy to parse JSON objects by simply passing them to the eval() function. Unfortunately, the use of eval() makes the application equivalently easy to exploit. Cleverly format strings containing malicious JavaScript may be stored as content on servers with weak validation or sent directly to the client browser using a spoofing or man in the middle attack. This JavaScript is then parsed and execute by the client's browser without their knowledge. Ultimately, this attack may be used to steal session cookies, send email on behalf of the victim, or any other impact available to the XSS attack.</P><H1>Impact</H1><UL><LI><STRONG>Confidentiality:</STRONG> Since the code runs in the same domain as the trusted site any cookies or other confidential site data can be read by the malicious AJAX code. <LI><STRONG>JavaScript code injection:</STRONG> By using the XMLHttpRequest object attackers can download and install JavaScript code modules to be run on the local browser dynamically and send information from the computer without the victim's knowledge.</LI></UL><H1>Vulnerabilities</H1><UL><LI>Failure to validate user input for script tags when that input can be echoed back into a web page. <LI>Failure to encode user supplied input upon display of the data <LI>Trusting data retrieved from a shared data store.</LI></UL><H1>Countermeasures</H1><P><STRONG>Constrain input:</STRONG> Use vigorous white-list style checking on any user input that may be reflected to a user's browser. </P><P><STRONG>HTMLEncode all user input on display:</STRONG> Use white-list style HTMLEncoding libraries to ensure all possibly malicious characters are encoded before being echoed back to the user, regardless of whether they're loaded as part of the original page load or through later XMLHttpRequests.</P><H1>Example</H1><P>Suppose you use an AJAX based web mail client. Because these are the days of Web 2.0, your mail client displays a list of your favorite contacts and lets you know their status. By default this status is set to "Online" or "Away," but a custom message may also be set by each contact that is reflect in your client. In order for this to work, the web page periodically updates this status list by requesting the list of contacts from the server. The server returns this information to the client as the following JSON object:</P><PRE>&#123;<BR>   "numberOnline": "3",<BR>   "nameAndStatus": &#91;<BR>   "Alice, Online",<BR>   "Bob, Online",<BR>   "Mallory, Away" &#93;<BR>&#125;</PRE><P>The following code shows the client JavaScript code which is called periodically to request the above object and update the DOM.</P><PRE>var contactStatusList;<BR>var http_request = new XMLHttpRequest();<BR>http_request.open("GET", url, true);<BR>http_request.onreadystatechange = function ()<BR> &#123;<BR>    if (http_request.readyState == 4)<BR> &#123;<BR>        if (http_request.status == 200)<BR> &#123;<BR>            contactStatusList = eval("(" &#43; http_request.responseText &#43; ")");<BR>        &#125;        http_request = null;    &#125;&#125;;http_request.send(null);</PRE><P>Now suppose that Mallory's status is set to a custom value. This may have been changed by Mallory herself or by a third party attacker. Either way, because the server providing the data to the mail client has poor validation, this status value is changed to include cleverly formatted malicious JavaScript. Suppose that instead of "Away" the value is changed to the following:</P><PRE>Away"&#125;);alert("Gotcha&#33;");//</PRE><P>The first thing to notice is that the JSON object, which represents a the contact status list, is valid JavaScript. Because of this the eval() can be used to evaluate it. The above code completes the status object, inserts additional JavaScript, and comments out the rest of the line. When the code is passed as to the eval() function the additional JavaScript is run. Note that "alert("Gotcha&#33;")" can be replaced with any malicious JavaScript and it will be run in the client's browser. Because the above code is an example, an alert message window will be displayed. In general, however, JavaScript could be downloaded and executed without the user's knowledge.</P><H1>Additional Resources</H1><UL><LI>For more information on AJAX including common vulnerabilities that are associated with the technology, see "Ajax Security Basics": <A href="http://www.securityfocus.com/infocus/1868">http://www.securityfocus.com/infocus/1868</A></LI></UL><UL><LI>For information on AJAX attacks and JavaScript Hijacking, see "JavaScript Hijacking": <A href="http://www.fortifysoftware.com/servlet/downloads/public/JavaScript_Hijacking.pdf">http://www.fortifysoftware.com/servlet/downloads/public/JavaScript_Hijacking.pdf</A></LI></UL><H1>Related Items</H1><UL><LI><A href="ruledisplay:BC10DCE2-CA48-44BF-8BF6-FEFBE8DCCB7E">Attack: Cross Site Scripting Attack</A> <LI><A href="ruledisplay:B9DD25F1-3C5C-40DD-A82E-464D0C02C14D">Attack: Command Injection Attack</A> <LI><A href="ruledisplay:685CA8C0-E102-4517-A539-4B826D1962EB">Attack: Double Encoding Attack</A> <LI><A href="ruledisplay:3EB8979E-59F0-4C2B-8D8A-CFB173E5D66B">Attack: HTTP Session Hijacking Attack</A> <LI><A href="ruledisplay:208A476B-ABCA-4630-9D02-746C52F47017">Attack: XML Injection Attack</A> <LI><A href="ruledisplay:42F599F0-D1D6-4F25-9CC2-D5473F19113F">Guideline: Validate All Data Passed Between Native and Java Code </A><LI><A href="ruledisplay:DD60FFDF-904D-45A8-8278-F3E8CEBA911F">Guideline: Do Not Rely on Request Validation </A><LI><A href="ruledisplay:58F9B51D-794F-4CFC-B568-7F5E55DEB402">Guideline: Do Not Rely on Client-Side Validation </A><LI><A href="ruledisplay:2D8158D1-E2D1-459F-9BD7-56D4B979EFE3">Guideline: Encode All Output Data </A><LI><A href="ruledisplay:D06E3B85-CCD8-41EC-8861-36D30BBAE909">Guideline: Validate Input for Length, Range, Format, and Type </A><LI><A href="ruledisplay:71225A92-ECA2-481E-ADEE-EA9C222DEA43">Guideline: Validate Input from All Sources </A></LI></UL>
]]></content></guidanceItem>