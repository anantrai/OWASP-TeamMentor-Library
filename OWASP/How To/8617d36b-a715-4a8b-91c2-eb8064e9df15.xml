<?xml version="1.0" encoding="utf-8"?><guidanceItem id="8617d36b-a715-4a8b-91c2-eb8064e9df15" type="howto" title="How to Encrypt Configuration Sections in ASP.NET Using DPAPI" cssFile="guidance.css" Date="2010-06-22T17:48:58.4177374Z" Author="" Category="Configuration" filePath="..\Libraries\OWASP\How To\8617d36b-a715-4a8b-91c2-eb8064e9df15.xml" Priority="" Rule_Type="Implementation" Source="ASP.NET 3.5" Status="" Technology="ASP.NET 3.5" Topic="Security" Type="How To" xmlns="urn:microsoft:guidanceexplorer:guidanceItem"><content><![CDATA[<H1>Summary</H1><P>This How to shows how to use the Windows Data Protection application programming interface (DPAPI) protected configuration provider and the Aspnet_regiis.exe tool to encrypt sections of your configuration files. You can use the Aspnet_regiis.exe tool to encrypt sensitive data, such as connection strings, held in the Web.config and Machine.config files. The DPAPI protected configuration provider supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application. Note that if your application is deployed in a Web farm, you should use the RSA protected configuration provider due to the ease with which RSA keys can be exported.</P><H1>Contents</H1><UL><LI>Objectives <LI>Overview <LI>Summary of Steps <LI>Step 1. Identify the Configuration Sections to be Encrypted <LI>Step 2. Choose the Machine or User Store <LI>Step 3. Encrypt Your Configuration File Data <LI>Web Farm Scenarios <LI>Additional Resources <LI></LI></UL><H1>Objectives</H1><UL><LI>Know which sections can and cannot be encrypted with the DPAPI protected configuration provider. <LI>Choose between user-level and machine-level DPAPI key storage. <LI>Use the DPAPI protected configuration provider to encrypt sections of your configuration file. <LI>Learn about the Web farm restrictions. </LI></UL><H1>Overview</H1><P>Configuration files such as the Web.config file are often used to hold sensitive information, including user names, passwords, database connection strings, and encryption keys. If you do not protect this information, your application is vulnerable to attackers or malicious users obtaining sensitive information such as account user names and passwords, database names and server names. The sections that usually contain sensitive information that you need to encrypt are the following:</P><UL><LI>&lt;appSettings&gt;. This section contains custom application settings. <LI>&lt;connectionStrings&gt;. This section contains connection strings. <LI>&lt;identity&gt;. This section can contain impersonation credentials. <LI>&lt;sessionState&gt;. The section contains the connection string for the out-of-process session state provider. </LI></UL><P>Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data.</P><H1>Summary of Steps</H1><P>To encrypt configuration sections by using the DPAPI data protection provider, perform the following steps: </P><UL><LI>Step 1. Identify the configuration sections to be encrypted. <LI>Step 2. Choose the machine or user store. <LI>Step 3. Encrypt your configuration file data. </LI></UL><H1>Step 1. Identify the Configuration Sections to Be Encrypted</H1><P>Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data.</P><H2>Sections You Cannot Encrypt Using Protected Configuration</H2><P>If you store sensitive data in any of the following configuration sections, you cannot encrypt it by using protected configuration and the Aspnet_regiis.exe tool: </P><UL><LI>&lt;<B>processModel</B>&gt; <LI>&lt;<B>runtime</B>&gt; <LI>&lt;<B>mscorlib</B>&gt; <LI>&lt;<B>startup</B>&gt; <LI>&lt;<B>system.runtime.remoting</B>&gt; <LI>&lt;<B>configProtectedData</B>&gt; <LI>&lt;<B>satelliteassemblies</B>&gt; <LI>&lt;<B>cryptographySettings</B>&gt; <LI>&lt;<B>cryptoNameMapping</B>&gt; <LI>&lt;<B>cryptoClasses</B>&gt; </LI></UL><P>For the configuration sections listed, you should use the Aspnet_setreg.exe tool, which is also available for previous versions of the .NET Framework. </P><P>For more information about using the Aspnet_setreg tool to encrypt data in these configuration sections, see Microsoft Knowledge Base article 329290, How to use the ASP.NET utility to encrypt credentials and session state connection strings.</P><H1>Step 2. Choose the Machine or User Store</H1><P>The <B>DataProtectionConfigurationProvider</B> supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application.</P><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;For information on where the user key is stored, see: <A href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsecure/html/windataprotection-dpapi.asp">Windows Data Protection</A>.</BLOCKQUOTE><H2>Machine Store</H2><P>Use machine-level key storage in the following situations: </P><UL><LI>Your application runs on its own dedicated server with no other applications. <LI>You have multiple applications on the same server that run and you want those applications to be able to share sensitive information. </LI></UL><H2>User Store</H2><P>Use user-level key storage if you run your application in a shared hosting environment and you want to make sure that your application's sensitive data is not accessible to other applications on the server. In this situation, each application should run under a separate identity, and the resources for the application&#8212;such as files and databases&#8212;should be restricted to that identity.</P><H1>Step 3. Encrypt Your Configuration File Data</H1><P>This step shows you how to encrypt a connection string in the Web.config file, first with the machine store and then with the user store.</P><H2>Using DPAPI with the Machine Store to Encrypt a Connection String in Web.config</H2><P>By default, the <B>DataProtectionConfigurationProvider</B> is configured to use DPAPI with the machine store. </P><H3>To encrypt the connectionStrings section in Web.config </H3><OL><LI>Create a new Web site named MachineDPAPI. Make sure that this directory is configured as a virtual directory. <LI>Add a Web.config configuration file to this directory. <LI>Add a sample <B>connectionString</B> similar to the following example. <DIV><PRE>&lt;connectionStrings&gt;<BR>&nbsp; &lt;add name="MyLocalSQLServer" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=aspnetdb;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data source=localhost;Integrated Security=SSPI;" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; providerName="System.Data.SqlClient"/&gt;<BR>&lt;/connectionStrings&gt;  </PRE></DIV><LI>To encrypt the <B>connectionStrings</B> section, run the following command from a .NET command prompt: <P><B>aspnet_regiis -pe "connectionStrings" -app "/MachineDPAPI" -prov "DataProtectionConfigurationProvider"</B> </P></LI></OL><P>The above command with the <B>-app</B> switch assumes that there is an IIS virtual directory called MachineDPAPI. If you are using the Visual Studio Web server instead of IIS, use the <B>-pef</B> switch, which allows you to specify the physical directory location of your configuration file.</P><P><B>aspnet_regiis.exe -pef "connectionStrings" C:\Projects\MachineDPAPI -prov "DataProtectionConfigurationProvider"</B></P><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;The Aspnet_regiis.exe utility tool is located in the following directory:</BLOCKQUOTE><BLOCKQUOTE>&#37;WinDir&#37;\Microsoft.NET\Framework\&lt;<I>versionNumber</I>&gt;</BLOCKQUOTE><UL><LI>The <B>-pe</B> switch specifies the configuration section to encrypt. <LI>The <B>-pef</B> switch specifies the configuration section to encrypt and allows you to supply the physical directory path for your configuration file. <LI>The <B>-app</B> switch specifies your Web application's virtual path. If it is a nested application, you need to specify the nested path from the root directory; for example, <B>"/test/aspnet/MachineDPAPI"</B>. <LI>The <B>-prov</B> switch specifies the provider name. <P>If the command is successful, you will see the following output: </P><DIV><PRE>Encrypting configuration section...Succeeded&#33;  </PRE></DIV><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;The DPAPI machine key is stored at the following location:</BLOCKQUOTE><BLOCKQUOTE>&#37;windir&#37;\system32\Microsoft\Protect\S-1-5-18</BLOCKQUOTE></LI></UL><OL><LI>Review the Web.config file, and examine the changes. The following elements are created: <UL><LI>&lt;<B>EncryptedData</B>&gt; <LI>&lt;<B>CipherData</B>&gt; <LI>&lt;<B>CipherValue</B>&gt; </LI></UL><P>Your modified Web.config file, with the <B>connectionStrings</B> section encrypted, should be similar to the following example. </P><DIV><PRE>...<BR>&lt;connectionStrings configProtectionProvider="DataProtectionConfigurationProvider"&gt; <BR>&nbsp; &lt;EncryptedData&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&lt;CipherValue&gt;AQAAANCMnd8BFdERjHoAwE/Cl&#43;sBAAAAexuIJ/8oFE&#43;sGTs7jBKZdgQAAAACAAAAAAADZgAAqAAAA<BR>BAAAAA<BR>Kms84dyaCPAeaSC1dIMIBAAAAAASAAACgAAAAEAAAAKaVI6aAOFdqhdc6w1Er3HMwAAAAcZ00MZOz1dI7kYRvkMIn/<BR>BmfrvoHNUwz6H9rcxJ6Ow41E3hwHLbh79IUWiiNp0VqFAAAAF2sXCdb3fcKkgnagkHkILqteTXh&lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp; &lt;/EncryptedData&gt;<BR>&lt;/connectionStrings&gt;<BR>...</PRE></DIV><LI>Add the following Default.aspx Web page to your application's virtual directory, and then browse to this page to verify that encryption and decryption worked correctly. <DIV><PRE>&lt;&#37;&#64; Page Language="C#" &#37;&gt;<BR><BR>&lt;script runat="server"&gt;<BR>&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; &#123;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Response.Write("Clear text connection string is: " &#43; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ConfigurationManager.ConnectionStrings<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#91;"MyLocalSQLServer"&#93;.ConnectionString);<BR>&nbsp;&nbsp;&nbsp; &#125;<BR>&lt;/script&gt;<BR>&lt;html&gt;<BR>&nbsp; &lt;body/&gt;<BR>&lt;/html&gt;  </PRE></DIV><LI><P>MyLocalSQLServer is the name of the connection string that you previously specified in the Web.config file. </P><LI>To change the <B>connectionStrings</B> section back to clear text, run the following command from the command prompt: <P><B>aspnet_regiis -pd "connectionStrings" -app "/MachineDPAPI"</B> </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Decrypting configuration section...<BR>Succeeded&#33;</PRE></DIV></LI></OL><P>To decrypt the <B>connectionStrings</B> section specifying a physical path to your application's configuration file, use the <B>-pdf</B> switch as shown here.</P><P><B>aspnet_regiis -pdf "connectionStrings" C:\Projects\MachineDPAPI</B></P><H2>Using DPAPI with a User Store to Encrypt a Connection String in Web.Config</H2><P>By default, the ASP.NET applications run under the NT AUTHORITY\Network Service account. When you access encrypted configuration sections using DPAPI with the user store, make sure that your application is running with the same user identity as the account you used to encrypt the data.</P><P>Using the <B>DataProtectionConfigurationProvider</B> and DPAPI with the user store requires a small amount of additional configuration in the Web.config file.</P><H3>To encrypt the connectionStrings section in Web.config </H3><OL><LI>Create a new Web site named UserDPAPI. Make sure that this directory is configured as a virtual directory. <LI>Add a Web.config configuration file to this directory. <LI>Add a sample <B>connectionString</B> similar to the following example. <DIV><PRE>&lt;connectionStrings&gt;<BR>&nbsp; &lt;add name="MyLocalSQLServer" connectionString="Initial Catalog=aspnetdb;<BR>data source=localhost;Integrated Security=SSPI;" providerName="System.Data.SqlClient"/&gt;<BR>&lt;/connectionStrings&gt;  </PRE></DIV><LI>Add and configure a protected configuration provider to use the user store. To do this, add the following &lt;<B>configProtectedData</B>&gt; section. You must set <B>useMachineProtection</B>=<B> "false"</B> to instruct the provider to use the user store. You must also use a unique provider name, or a run-time error will occur. <DIV><PRE>&lt;configProtectedData&gt;<BR>&nbsp; &lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;add useMachineProtection="false" keyEntropy="" name="MyUserDataProtectionConfigurationProvider" <BR>type="System.Configuration.DpapiProtectedConfigurationProvider, System.Configuration,<BR>&#9;&#9; Version=3.5.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" /&gt;<BR>&nbsp; &lt;/providers&gt;<BR>&lt;/configProtectedData&gt;  </PRE></DIV><LI>Run the following command from a command prompt to encrypt the <B>connectionStrings</B> section: <P><B>Aspnet_regiis -pe "connectionStrings" -app "/UserDPAPI" -prov "MyUserDataProtectionConfigurationProvider"</B> </P><UL><LI>The -<B>pe</B> switch specifies the configuration section to encrypt. <LI>The -<B>app</B> switch specifies your Web application's virtual path. If it is a nested application, you need to specify the nested path from the root directory; for example: <B>"/test/aspnet/UserDPAPI"</B>. <LI>The -<B>prov</B> switch specifies the provider name. In this case, this is set to <B>"MyUserDataProtectionConfigurationProvider"</B> which is the name you specified when configuring the provider in the step 3. </LI></UL><P>If the command is successful, you will see the following output: </P><DIV><PRE>Encrypting configuration section...Succeeded&#33;</PRE></DIV><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;For information on where the user key is stored, see: <A href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsecure/html/windataprotection-dpapi.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsecure/html/windataprotection-dpapi.asp</A></BLOCKQUOTE></LI></OL><P>Because your application must access the data by using the same identity that you used to encrypt the data, you may need to run the encryption command using your application's service account identity. To do so, you can start a command window by using the <B>runas</B> command, specifying an appropriate domain and user name, as follows:</P><P><B>Runas /profile /user:domain\user cmd</B></P><P>When you run Aspnet_regiis from the resulting command window, it will use the specified identity to perform the encryption. This enables your application that uses the same identity to decrypt the data at run time. </P><OL><LI>Review the Web.config file, and examine the changes. The following elements are created: <UL><LI>&lt;<B>EncryptedData</B>&gt; <LI>&lt;<B>CipherData</B>&gt; <LI>&lt;<B>CipherValue</B>&gt; </LI></UL><P>Your modified Web.config file, with the <B>connectionStrings</B> section encrypted should be similar to the following example. </P><DIV><PRE>...<BR>&lt;connectionStrings configProtectionProvider="MyUserDataProtectionConfigurationProvider"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;EncryptedData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;AQAAANCMnd8BFdERjHoAwE/Cl&#43;sBAAAAWuizHyLxzk&#43;U4/8NnMRAjQAAAAACAAAAA<BR>AADZgAAqAAAABAAAADLFqu00qT0BeGh6wmHHGySAAAAAASAAACgAAAAEAAAAM56z6ezglmufZGcta83RKGgAQAA<BR>tvDpExhD6h95lfWBt0FqZYzxupI2IepH/XlhLB5rsuuQDCJUL7XGIIsaVW2oNQxgNCPXxRSuCxHQ7vqgbh4G7xH<BR>k0wdyws5Ax4T/RYJbfYEF5KAPzShdmdoZdkY/FOWrVEgAr7LzKFBoDcPJBvgX&#43;lfsJdBNeWRB5BqRX552dUFjtDl<BR>p8u3K/dA9twWDU2w/cRLMXJtVZ/y/ICI1fzXjX3u7sY9K1IC&#43;5Hbi7nouCK6Ze5RLBnL0Zfdq0PyGlj2To4ftAYA<BR>T0SzkBaxlXRQSzMhX&#43;7c&#43;rgKpMqtG9XjAW26x3IJAp2/uAr2zOZqH&#43;tskamHYSruhTicHJDTtP&#43;r6Rs21y2QkRT9<BR>Hb9oPd9B5mDIzGtDkifWBbmwLv4XFuYcna1Zgny7McSxMI62jxayVlZKcS5dXV0shwLoUjbTDcXQmFKsRvo2sCW8<BR>6wcN8ad02jhKCQMf9SWnZpd849mlqgMFiQQSFlZ6Q&#43;vJLrXqVb8zmVZemQPQcY/DktgjOvjn0iOZ3zhl20fRENOa<BR>3ZIWvvK8p9pblz3sEfS19MAW0JtYUAAAAayvNPot3An7LaCTdFYrEip&#43;fTU4=&lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/EncryptedData&gt;<BR>&nbsp; &lt;/connectionStrings&gt;<BR>...</PRE></DIV><LI>Add the following Default.aspx Web page to your application's virtual directory, and then browse to this page to verify that encryption and decryption work correctly. <DIV><PRE>&lt;&#37;&#64; Page Language="C#" &#37;&gt;&lt;script runat="server"&gt;<BR>&nbsp; protected void Page_Load(object sender, EventArgs e)<BR>&nbsp; &#123;<BR>&nbsp;&nbsp;&nbsp; Response.Write("Clear text connection string is: " &#43; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ConfigurationManager.ConnectionStrings<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#91;"MyLocalSQLServer"&#93;.ConnectionString);<BR>&nbsp; &#125;<BR>&lt;/script&gt;<BR>&lt;html&gt;<BR>&nbsp; &lt;body/&gt;<BR>&lt;/html&gt;  </PRE></DIV><P>MyLocalSQLServer is the name of the connection string that you previously specified in the Web.config file. </P><P>Then, in the Web.config file, you need to enable impersonation as shown in the following example. </P><DIV><PRE>&lt;system.web&gt;<BR>&nbsp; ...<BR>&nbsp; &lt;identity impersonate="true" /&gt;<BR>&nbsp; ...<BR>&lt;/system.web&gt;  </PRE></DIV><LI><P>If your application runs under a different account than the one used to encrypt the data, ASP.NET will be unable to access the user store where the DPAPI key is held and will generate the following error: </P><DIV><PRE>Failed to decrypt using provider 'MyUserDataProtectionConfigurationProvider'.<BR>&nbsp;Error message from the provider: Key not valid for use in specified state. <BR>(Exception from HRESULT: 0x8009000B)  </PRE></DIV><LI>To change the <B>connectionStrings</B> section back to clear text, run the following command from the command prompt: <P><B>aspnet_regiis -pd "connectionStrings" -app "/UserDPAPI"</B> </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Decrypting configuration section...<BR>Succeeded&#33;  </PRE></DIV></LI></OL><H1>Web Farm Scenarios</H1><P>If you want to deploy the same encrypted configuration file on multiple servers in a Web farm, you should use the <B>RSAProtectedConfigurationProvider</B>. This provider makes it easy for you encrypt the data on one server computer and then export the RSA private key needed to decrypt the data. You can then deploy the configuration file and the exported key to the target servers, and then re-import the keys.</P><HR><P>Adapted from Microsoft patterns &amp; practices guidance.</P>

]]></content></guidanceItem>