<?xml version="1.0" encoding="utf-8"?><guidanceItem id="634d908c-b966-40d6-a87b-1cb465af6684" type="howto" title="How to Encrypt Configuration Sections in ASP.NET Using RSA" cssFile="guidance.css" Date="2010-07-22T18:03:56.9375Z" Author="" Category="Configuration" filePath="..\Libraries\OWASP\How To\634d908c-b966-40d6-a87b-1cb465af6684.xml" Priority="" Rule_Type="Implementation" Source="SI" Status="" Technology="ASP.NET 3.5" Topic="Security" Type="How To" xmlns="urn:microsoft:guidanceexplorer:guidanceItem"><content><![CDATA[<H1>Summary</H1><P>This How to shows how to use the RSA Protected Configuration provider and the Aspnet_regiis.exe tool to encrypt sections of your configuration files. You can use Aspnet_regiis.exe tool to encrypt sensitive data, such as connection strings, held in the Web.config and Machine.config files. You can easily export and import RSA keys from server to server. This makes RSA encryption particularly effective for encrypting configuration files used on multiple servers in a Web farm.</P><H1>Contents</H1><UL><LI>Objectives <LI>Overview <LI>Summary of Steps <LI>Step 1. Identify the Configuration Sections to Be Encrypted <LI>Step 2. Choose Machine-Level or User-Level Containers <LI>Step 3. Encrypt Your Configuration File Data <LI>Web Farm Scenarios <LI>Additional Resources </LI></UL><H1>Objectives</H1><UL><LI>Learn about key changes for encrypting sensitive data in configuration files in ASP.NET. <LI>Learn how to choose between machine-level and user-level containers. <LI>Know which sections can and cannot be encrypted with the RSA protected configuration provider. <LI>Use the RSA protected configuration provider to encrypt connection strings. <LI>Create RSA key containers. <LI>Import and export RSA keys across multiple servers in a Web farm. </LI></UL><H1>Overview</H1><P>Configuration files such as the Web.config file are often used to hold sensitive information, including user names, passwords, database connection strings, and encryption keys. The sections that usually contain sensitive information that you need to encrypt are the following:</P><UL><LI>&lt;appSettings&gt;. This section contains custom application settings. <LI>&lt;connectionStrings&gt;. This section contains connection strings. <LI>&lt;identity&gt;. This section can contain impersonation credentials. <LI>&lt;sessionState&gt;. This section contains the connection string for the out-of-process session state provider. </LI></UL><P>Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data.</P><H1>Summary of Steps</H1><P>To encrypt configuration sections by using the RSA protected configuration provider, perform the following steps:</P><UL><LI>Step 1. Identify the configuration sections to be encrypted. <LI>Step 2. Choose machine-level or user-level key containers. <LI>Step 3. Encrypt your configuration file data. </LI></UL><H1>Step 1. Identify the Configuration Sections to Be Encrypted</H1><P>Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data.</P><H2>Sections You Cannot Encrypt Using Protected Configuration</H2><P>If you store sensitive data in any of the following configuration sections, you cannot encrypt it by using a protected configuration provider and the Aspnet_regiis.exe tool:</P><UL><LI>&lt;processModel&gt; <LI>&lt;runtime&gt; <LI>&lt;mscorlib&gt; <LI>&lt;startup&gt; <LI>&lt;system.runtime.remoting&gt; <LI>&lt;configProtectedData&gt; <LI>&lt;satelliteassemblies&gt; <LI>&lt;cryptographySettings&gt; <LI>&lt;cryptoNameMapping&gt; <LI>&lt;cryptoClasses&gt; </LI></UL><P>For the configuration sections listed, you should use the Aspnet_setreg.exe tool, which is also available for previous versions of the .NET Framework.</P><H1>Step 2. Choose Machine-Level or User-Level Key Containers</H1><P>The <B>RSAProtectedConfigurationProvider</B> supports machine-level and user-level key containers for key storage. Machine-level key containers are available to all users, but a user-level key container is available to that user only.</P><P>The choice of container depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application.</P><H2>Machine Key Container</H2><P>Use a machine-level key container in the following situations: </P><UL><LI>Your application runs on its own dedicated server with no other applications. <LI>You have multiple applications on the same server and you want those applications to be able to share sensitive information and the same encryption key. </LI></UL><P>RSA machine key containers are stored in the following folder: </P><P>\Documents and Settings\All Users\Application Data\Microsoft\Crypto\RSA\MachineKeys</P><H2>User Key Container</H2><P>Use a user-level key container if you run your application in a shared hosting environment and you want to make sure that your application's sensitive data is not accessible to other applications on the server. In this situation, each application should have a separate identity and the resources for the application&#8212;such as files, and databases&#8212;should be restricted to that identity.</P><P>RSA user-level key containers are stored in the following folder:</P><P>\Documents and Settings\&#123;UserName&#125;\Application Data\Microsoft\Crypto\RSA</P><H1>Step 3. Encrypt Your Configuration File Data</H1><P>This step shows you how to encrypt a connection string in the Web.config file. It shows you how to do this with the machine store and then with the user store.</P><H2>Using RSA with a Machine-Level Key Container to Encrypt a Connection String in Web.Config</H2><P>The <B>RSAProtectedConfigurationProvider</B> is the default provider and is configured to use the machine-level key container.</P><H3>To encrypt the connectionStrings section in Web.config </H3><OL><LI>Create a new Web site named MachineRSA. Make sure that this directory is configured as a virtual directory. <LI>Add a Web.config configuration file to this directory. <LI>Add a sample <B>connectionString</B> similar to the following example: <DIV><PRE>&lt;connectionStrings&gt;<BR>&nbsp; &lt;add name="MyLocalSQLServer" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=aspnetdb;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data source=localhost;Integrated Security=SSPI;" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; providerName="System.Data.SqlClient"/&gt;<BR>&lt;/connectionStrings&gt;  </PRE></DIV><LI>Run the following command from a .NET command prompt to encrypt the <B>connectionStrings</B> section: <P><B>aspnet_regiis -pe "connectionStrings" -app "/MachineRSA"</B> </P><P>The above command with the-<B>app</B> switch assumes that there is an IIS virtual directory called MachineRSA. If you are using the Visual Studio Web server instead of IIS, use the-<B>pef</B> switch, which allows you to specify the physical directory location of your configuration file. </P><P><B>aspnet_regiis.exe -pef "connectionStrings" C:\Projects\MachineRSA</B> </P><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;The Aspnet_regiis.exe utility tool is located in the following directory:</BLOCKQUOTE><BLOCKQUOTE>&#37;WinDir&#37;\Microsoft.NET\Framework\&lt;<I>versionNumber</I>&gt;</BLOCKQUOTE><UL><LI>The <B>-pe</B> switch specifies the configuration section to encrypt. This is the XML element name of the configuration section. <P>For nested elements, such as the &lt;<B>pages</B>&gt; section which is inside &lt;<B>system.web</B>&gt;, the XML name must include the containing section groups; for example: <B>"system.web/pages"</B>. </P><LI>The <B>-pef</B> switch specifies the configuration section to encrypt and allows you to supply the physical directory path for your configuration file. <LI>The <B>-app</B> switch specifies your Web application's virtual path. If it is a nested application, you need to specify the nested path from the root directory; for example, <B>"/test/aspnet/MachineRSA"</B>. <LI>Because you are using the default provider with default settings, you do not need to use the-<B>prov</B> switch, which specifies the provider name. </LI></UL><P>If the command is successful, you will see the following output: </P><DIV><PRE>Encrypting configuration section...Succeeded&#33;  </PRE></DIV><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;The RSA machine key containers are stored in the following folder:</BLOCKQUOTE><BLOCKQUOTE>\Documents and Settings\All Users\Application Data\Microsoft\Crypto\RSA\MachineKeys</BLOCKQUOTE><LI>Review the Web.config file, and examine the changes. The following elements are created: <UL><LI>&lt;<B>EncryptedData</B>&gt; <LI>&lt;<B>EncryptionMethod</B>&gt; <LI>&lt;<B>KeyInfo</B>&gt; <LI>&lt;<B>EncryptedKey</B>&gt; <LI>&lt;<B>KeyName</B>&gt; <LI>&lt;<B>CipherData</B>&gt; <LI>&lt;<B>CipherValue</B>&gt; </LI></UL><P>Your modified Web.Config file, with the <B>connectionStrings</B> section encrypted, should be similar to the following example: </P><DIV><PRE>...<BR>&lt;connectionStrings configProtectionProvider="RsaProtectedConfigurationProvider"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;EncryptedData Type="<A href="http://www.w3.org/2001/04/xmlenc#Element">http://www.w3.org/2001/04/xmlenc#Element</A>"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;              xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#tripledes-cbc">http://www.w3.org/2001/04/xmlenc#tripledes-cbc</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptedKey xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#rsa-1_5">http://www.w3.org/2001/04/xmlenc#rsa-1_5</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyName&gt;Rsa Key&lt;/KeyName&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;R7cyuRk&#43;SXJoimz7wlOpJr/YLeADGnwJVcmElHbrG/<BR>                         B5dDTE4C9rzSmmTsbJ9Xcl2oDQt1qYma9L7pzQsQQYqLrkajqJ4i6ZQH1cmiot8ja7Vh&#43;yItes7TRU1AoXN9T0mbX5H1Axm0O3X/<BR>                         285/MdXXTUlPkDMAZXmzNVeEJHSCE=<BR>            &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/EncryptedKey&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;d2&#43;&#43;QtjcVwIkJLsye&#43;dNJbCveORxeWiVSJIbcQQqAFofhay1wMci8FFlbQWttiRYFcvxrmVfNSxoZV8GjfPtppiodhOzQZ&#43;0/<BR>                     QIFiU9Cifqh/T/7JyFkFSn13bTKjbYmHObKAzZ&#43;Eg6gCXBxsVErzH9GRphlsz5ru1BytFYxo/<BR>                     lUGRvZfpLHLYWRuFyLXnxNoAGfL1mpQM7M46x5YWRMsNsNEKTo/PU9/Jvnh/<BR>                     lT&#43;GlcgCs2JRpyzSfKE7zSJH&#43;TpIRtd86PwQ5HG3Pd2frYdYw0rmlmlI9D<BR>        &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/EncryptedData&gt;<BR>&nbsp; &lt;/connectionStrings&gt;<BR>...</PRE></DIV><LI>Add the following Default.aspx Web page to your application's virtual directory, and then browse to this page to verify that encryption and decryption work correctly. <DIV><PRE>&lt;&#37;&#64; Page Language="C#" &#37;&gt;<BR>&lt;script runat="server"&gt;<BR>&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; &#123;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Response.Write("Clear text connection string is: " &#43; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       ConfigurationManager.ConnectionString&#91;"MyLocalSQLServer"&#93;.ConnectionString);<BR>&nbsp;&nbsp;&nbsp; &#125;<BR>&lt;/script&gt;<BR>&lt;html&gt;<BR>&nbsp; &lt;body /&gt;<BR>&lt;/html&gt;  </PRE></DIV><LI><P>MyLocalSQLServer is the name of the connection string you previously specified in the Web.config file. </P><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;If your ASP.NET application identity does not have access to the .NET Framework configuration key store, the following message is returned:</BLOCKQUOTE><DIV><PRE>Parser Error Message: Failed to decrypt using provider 'RsaProtectedConfigurationProvider'.<BR>Error message from the provider: The handle is invalid.  </PRE></DIV><BLOCKQUOTE><B><B>To </B>grant access to the ASP.NET application identity</B></BLOCKQUOTE><OL><LI>If you are not sure which identity to use, check the identity from a Web page by using the following code: <DIV><PRE>using System.Security.Principal;<BR>...<BR>protected void Page_Load(object sender, EventArgs e)<BR>&#123;<BR>&nbsp; Response.Write(WindowsIdentity.GetCurrent().Name);<BR>&#125;  </PRE></DIV><LI>By default, ASP.NET applications on Windows Server 2003 run using the NT Authority\Network Service account. Open a .NET command prompt, and use the following command to give this account access to the NetFrameworkConfigurationKey store: <BLOCKQUOTE><B><B>aspnet_regiis</B> -pa "NetFrameworkConfigurationKey" "NT Authority\Network Service"</B></BLOCKQUOTE><BLOCKQUOTE><B>If</B> the command runs successfully you will see the following output:</BLOCKQUOTE><DIV><PRE>Adding ACL for access to the RSA Key container...Succeeded&#33;  </PRE></DIV><BLOCKQUOTE><B>You </B>can check the ACL of the file in the following folder:</BLOCKQUOTE><BLOCKQUOTE><B><B>\Documents</B> and Settings\All Users\Application Data\Microsoft\Crypto\RSA\MachineKeys</B></BLOCKQUOTE><BLOCKQUOTE><B>Your</B><B> </B>RSA key container file is the file in this folder with the most recent timestamp.</BLOCKQUOTE></LI></OL><LI>To change the <B>connectionStrings</B> section back to clear text, run the following command from the command prompt: <P><B>aspnet_regiis -pd "connectionStrings" -app "/MachineRSA"</B> </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Decrypting configuration section...Succeeded&#33;  </PRE></DIV><P>To decrypt the <B>connectionStrings</B> section that specifies a physical path to your application's configuration file, use the <B>-pdf</B> switch as shown here. </P><P><B>aspnet_regiis -pdf "connectionStrings" C:\Projects\MachineRSA</B> </P></LI></OL><H2>Using RSA with a User-level Key Container to Encrypt a Connection String in Web.config</H2><P>The following steps show you how to encrypt a &lt;<B>connectionStrings</B>&gt; section by using the <B>RSAProtectedConfigurationProvider</B> (RSA) with a user-level key container.</P><P>By default, the ASP.NET applications run under the NT AUTHORITY \ Network Service account. When you access encrypted configuration sections using RSA encryption with the user-level key container, make sure that your application is running with the same user identity as the account you used to encrypt the data. </P><H3>To encrypt the connectionStrings section in Web.config </H3><OL><LI>Create a new Web site named UserRSA. Make sure that this directory is configured as a virtual directory. <LI>Add a Web.config configuration file to this directory. <LI>Add a sample <B>connectionString</B> similar to the following example: <DIV><PRE>&lt;connectionStrings&gt;<BR>&nbsp; &lt;add name="MyLocalSQLServer" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=aspnetdb;data source=localhost;Integrated Security=SSPI;"<BR>       providerName="System.Data.SqlClient" /&gt;<BR>&lt;/connectionStrings&gt;  </PRE></DIV><LI>Add and configure a protected configuration provider to use a user-level key container. To do this, add the following &lt;<B>configProtectedData</B>&gt; section to your Web.config file. You must set <B>useMachineContainer</B>=<B> "false"</B> to instruct the provider to use the user-level key container. You must also use a unique provider name or a run-time error will be generated. <DIV><PRE>&lt;configProtectedData&gt;<BR>&nbsp; &lt;providers&gt;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; &lt;add keyContainerName="NetFrameworkConfigurationKey"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    useMachineContainer="false"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    description="Uses RsaCryptoServiceProvider to encrypt and decrypt"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    name="MyUserRSAProtectedConfigurationprovider" <BR>         type="System.Configuration.RsaProtectedConfigurationProvider,System.Configuration,<BR>               Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" /&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/providers&gt;&nbsp;&nbsp; <BR>&lt;/configProtectedData&gt;  </PRE></DIV><LI>Run the following command from an SDK Command Prompt to encrypt the <B>connectionStrings</B> section: <P><B>aspnet_regiis -pe "connectionStrings" -app "/UserRSA" -prov "MyUserRSAProtectedConfigurationProvider"</B> </P><UL><LI>The <B>-pe</B> switch specifies the configuration section to encrypt. This is the XML element name of the configuration section. <P>For nested elements, such as the &lt;<B>pages</B>&gt; section, which is inside &lt;<B>system.web</B>&gt;, the XML name must include the containing section groups; for example, <B>"system.web/pages"</B>. </P><LI>The <B>-app</B> switch specifies your Web application's virtual path. If it is a nested application, you need to specify the nested path from the root directory; for example, <B>"/test/aspnet/MachineRSA"</B>. <LI>The <B>-prov</B> switch specifies the provider name. In this case, this is set to <B>"MyUserRSAProtectedConfigurationProvider"</B> which is the name you specified when configuring the provider in step 4. </LI></UL><P>If the command is successful, you will see the following output: </P><DIV><PRE>Encrypting configuration section...Succeeded&#33;  </PRE></DIV><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;RSA user-level key containers are stored in the following folder.</BLOCKQUOTE><BLOCKQUOTE>\Documents and Settings\&#123;UserName&#125;\Application Data\Microsoft\Crypto\RSA</BLOCKQUOTE><LI>Review the Web.config and examine the changes. The following elements are created. <UL><LI>&lt;<B>EncryptedData</B>&gt; <LI>&lt;<B>EncryptionMethod</B>&gt; <LI>&lt;<B>KeyInfo</B>&gt; <LI>&lt;<B>EncryptedKey</B>&gt; <LI>&lt;<B>KeyName</B>&gt; <LI>&lt;<B>CipherData</B>&gt; <LI>&lt;<B>CipherValue</B>&gt; </LI></UL><P>Your modified Web.Config file, with the <B>connectionStrings</B> section encrypted, should be similar to the following example: </P><DIV><PRE>...<BR>  &lt;connectionStrings configProtectionProvider="MyUserRSAProtectedConfigurationprovider"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;EncryptedData Type="<A href="http://www.w3.org/2001/04/xmlenc#Element">http://www.w3.org/2001/04/xmlenc#Element</A>"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;              xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#tripledes-cbc">http://www.w3.org/2001/04/xmlenc#tripledes-cbc</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptedKey xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#rsa-1_5">http://www.w3.org/2001/04/xmlenc#rsa-1_5</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyName&gt;Rsa Key&lt;/KeyName&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;In7jNc0GA1eE5nvVR2hrHQ6cC1O1kMbfBXH0alBwlY2OBM4sMa8NbK4pBnUdxFkrx&#43;oSzLYE8SHS6dYZwE3Uf5x7hk46Jx&#43;Z/<BR>                         hn1hneWMyxWn23t41708lQzySsotYnzL5VOdR4P7MrIlhW9eSpbWp7PopSzcLxlGbs41dH7L3E=<BR>            &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/EncryptedKey&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;Zbu2LQQeiHaUFXWPjLvPR9OLwrozCZj5i2zvcEFlx/<BR>                     UICt2Cn0fTdy51dbHQRjTUXnOyx2PC5vptALXsvxrhPo5I&#43;<BR>                     I2SCr21rRUQ5H55P0ejJZMsAirkNjdhCe5RflVLdK96a6Sw0cz93inWi4rNkE1SiXB76cD08Y&#43;DHrsjmGkW8/<BR>                     TeHCK2f4xSykmdJGRwpxxdt2&#43;3DxMjQPfg39Xkr4JjRlE6FvQ/R6hkEyyqLmCxUxbTV/<BR>                     &#43;mcBcwyE3AzrbOIl&#43;627SG1fP4ovLmMkNvjlTl5lCZnoj6<BR>        &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/EncryptedData&gt;<BR>&nbsp; &lt;/connectionStrings&gt;<BR>...</PRE></DIV><LI>Add the following Default.aspx Web page to your application's virtual directory, and then browse to this page to verify that encryption and decryption works correctly. <DIV><PRE>&lt;&#37;&#64; Page Language="C#" &#37;&gt;<BR>&lt;script runat="server"&gt;<BR>&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; &#123;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Response.Write("Clear text connection string is: " &#43; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ConfigurationManager.ConnectionStrings&#91;"MyLocalSQLServer"&#93;.ConnectionString);<BR>&nbsp;&nbsp;&nbsp; &#125;<BR>&lt;/script&gt;<BR>&lt;html&gt;<BR>&nbsp; &lt;body /&gt;<BR>&lt;/html&gt;  </PRE></DIV><LI><P>Because your application must access the data using the same identity that you used to encrypt the data, you often need to run the encryption command using your application's service account identity. To do so, you can start a command Window by using the <B>runas</B> command as shown below specifying an appropriate domain and user name. </P><P><B>Runas /profile /user:domain\user cmd</B> </P><P>When you run Aspnet_regiis from the resulting command window, it uses the specified identity to perform the encryption. This allows the application that uses the same identity to decrypt the data at run time. </P><P>If your application runs under a different account than the one used to encrypt the data, ASP.NET will be unable to access the RSA user-level key container and will generate the following error: </P><DIV><PRE>Parser Error Message: Failed to decrypt using provider 'RsaProtectedConfigurationProvider'. <BR>Error message from the provider: Keyset does not exist  </PRE></DIV><LI>To change the <B>connectionStrings</B> section back to clear text, run the following command from the .NET command prompt: <P><B>aspnet_regiis -pd "connectionStrings" -app "/UserRSA"</B> </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Decrypting configuration section...Succeeded&#33;  </PRE></DIV></LI></OL><H1>Web Farm Scenarios</H1><P>You can use RSA encryption in Web farms, because you can export RSA keys. You need to do this if you encrypt data in a Web.config file prior to deploying it to other servers in a Web farm. In this case, the private key required to decrypt the data must be exported and deployed to the other servers.</P><H2>Using the RSA Provider to Encrypt a Connection String in Web.config in a Web Farm</H2><P>To do this, you must create a custom RSA encryption key container and deploy the same key container on all servers in your Web farm. This won't work by default because the default RSA encryption key, <B>"NetFrameworkConfigurationKey"</B>, is different for each computer.</P><H3>To use RSA encryption in a Web farm </H3><OL><LI>Run the following command from a command prompt to create a custom RSA encryption key: <P><B>aspnet_regiis -pc "CustomKeys" -exp</B> </P><P>The <B>-exp</B> switch indicates that the keys are exportable. </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Creating RSA Key container...Succeeded&#33;  </PRE></DIV><P>You can verify that a custom key container exists by looking for the file and checking timestamps in the following location: </P><P>\Documents and Settings\All Users\Application Data\Microsoft\Crypto\RSA<BR>\MachineKeys </P><LI>Create a new Web project named WebFarmRSA. Make sure that this directory is configured as a virtual directory. <LI>Add a Web.config configuration file to this directory. <LI>Add a sample <B>connectionString</B> similar to the following example: <DIV><PRE>&lt;connectionStrings&gt;<BR>&nbsp; &lt;add name="MyLocalSQLServer" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=aspnetdb;data source=localhost;Integrated Security=SSPI;" <BR>       providerName="System.Data.SqlClient" /&gt;<BR>&lt;/connectionStrings&gt;  </PRE></DIV><LI>Add and configure a custom protected configuration provider. To do this, add the following &lt;<B>configProtectedData</B>&gt; section to the Web.config file. Note that the key container name is set to <B>"CustomKeys"</B>, which is the name of the key container created previously. <DIV><PRE>...<BR>&lt;configProtectedData&gt;<BR>&nbsp; &lt;providers&gt;<BR>&nbsp; &lt;add keyContainerName="CustomKeys" <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;useMachineContainer="true"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;description="Uses RsaCryptoServiceProvider to encrypt and decrypt"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name="CustomProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type="System.Configuration.RsaProtectedConfigurationProvider,System.Configuration,<BR>             Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" /&gt;<BR>&nbsp; &lt;/providers&gt;<BR>&lt;/configProtectedData&gt;<BR>...  </PRE></DIV><LI>Run the following command from an SDK Command Prompt to encrypt the <B>connectionStrings</B> section using the custom RSA key: <P><B>aspnet_regiis -pe "connectionStrings" -app "/WebFarmRSA" -prov "CustomProvider"</B> </P><P>If the encryption is successful, you will see the following output: </P><DIV><PRE>Encrypting configuration section...Succeeded&#33;  </PRE></DIV><LI>Review the Web.config file and examine the changes. The following elements are modified: <UL><LI>&lt;<B>EncryptedData</B>&gt; <LI>&lt;<B>CipherData</B>&gt; <LI>&lt;<B>CipherValue</B>&gt; </LI></UL><P>Your modified Web.Config file, with the <B>connectionStrings</B> section encrypted, should be similar to the following example: </P><DIV><PRE>...<BR>  &lt;connectionStrings configProtectionProvider="CustomProvider"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;EncryptedData Type="<A href="http://www.w3.org/2001/04/xmlenc#Element">http://www.w3.org/2001/04/xmlenc#Element</A>"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;              xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#tripledes-cbc">http://www.w3.org/2001/04/xmlenc#tripledes-cbc</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptedKey xmlns="<A href="http://www.w3.org/2001/04/xmlenc">http://www.w3.org/2001/04/xmlenc</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EncryptionMethod Algorithm="<A href="http://www.w3.org/2001/04/xmlenc#rsa-1_5">http://www.w3.org/2001/04/xmlenc#rsa-1_5</A>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyInfo xmlns="<A href="http://www.w3.org/2000/09/xmldsig">http://www.w3.org/2000/09/xmldsig</A>#"&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;KeyName&gt;Rsa Key&lt;/KeyName&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;MWOaFwkByLRrvoGYeFUPMmN7e9uwC0D7gFEeyxs3Obll710dLQvD5XaMWcRxg1WwtOE9nysPQRrIJUaCm0b26LGUoa/<BR>                         giGEfvWnslU2kig9SPICzsQAqUSB/inhRckWceb2xdy7TT&#43;EI/vfsu6itJwE2AicMCTwx5I828mP8lV4=<BR>            &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/EncryptedKey&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/KeyInfo&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;IKO9jezdlJ/k1snyw5&#43;e11cd9IVTlVfHBHSiYLgICf1EnMNd5WxVDZWP1uOW2UaY3Muv7HrSZCRbqq6hfA2uh2rxy5qAzFP&#43;iu7Sg/<BR>                     ku1Zvbwfq8p1UWHvPCukeyrBypiv0wpJ9Tuif7oP4Emgaoa&#43;ewLnETSN411Gow28EKcLpbKWJDOC/<BR>                     9o7g503YM4cnIvkQOomkYlL&#43;MzMb3Rc1FSLiM9ncKQLZi&#43;<BR>                     JkRhlDIxFlsrFpKJhdNf5A0Sq2P71ZLI6G6QDCehHyn3kCZyBmVWJ0ueoGWXV4y<BR>        &lt;/CipherValue&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/EncryptedData&gt;<BR>&nbsp; &lt;/connectionStrings&gt;<BR>...</PRE></DIV><LI>Run the following command from a .NET command prompt to export the custom RSA encryption key: <P><B>aspnet_regiis -px "CustomKeys" "C:\CustomKeys.xml" -pri</B> </P><P>The <B>-pri</B> switch causes the private and public key to be exported. This enables both encryption and decryption. Without the-<B>pri</B> switch, you would only be able to encrypt data with the exported key. </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Exporting RSA Keys to file...Succeeded&#33;  </PRE></DIV><LI>Deploy the application and the encrypted Web.config file on a different server computer. Also copy the CustomKeys.xml file to a local directory on the other server, for example to the C:\ directory. <LI>On the destination server, run the following command from a command prompt to import the custom RSA encryption keys: <P><B>aspnet_regiis -pi "CustomKeys" "C:\CustomKeys.xml"</B> </P><P>If the command is successful, you will see the following output: </P><DIV><PRE>Importing RSA Keys from file..Succeeded&#33;  </PRE></DIV><BLOCKQUOTE><B>Note</B>&nbsp;&nbsp;&nbsp;After you have finished exporting and importing the RSA keys, it is important for security reasons to delete the CustomsKeys.xml file from both machines. </BLOCKQUOTE><LI>Grant access to the ASP.NET application identity. <P>The account used to run your Web application must be able to read the RSA key container. If you are not sure which identity your application uses, you can check this by adding the following code to a Web page: </P><DIV><PRE>using System.Security.Principal;<BR>...<BR>protected void Page_Load(object sender, EventArgs e)<BR>&#123;<BR>&nbsp;&nbsp;&nbsp; Response.Write(WindowsIdentity.GetCurrent().Name);<BR>&#125;  </PRE></DIV><P>By default, ASP.NET applications on Windows Server 2003 run using the NT Authority\Network Service account. The following command grants this account access to the CustomKeys store: </P><P><B>aspnet_regiis -pa "CustomKeys" "NT Authority\Network Service"</B> </P><P>If the command runs successfully, you will see the following output. </P><DIV><PRE>Adding ACL for access to the RSA Key container...Succeeded&#33;  </PRE></DIV><P>You can check the ACL of the file in the following folder: </P><DIV><PRE>\Documents and Settings\All Users\Application Data\Microsoft\Crypto\RSA\MachineKeys  </PRE></DIV><P>Your RSA key container file will be the one in this folder with the most recent timestamp. </P><LI>Add the following Default.aspx Web page to your application's virtual directory, and then browse to this page to verify that encryption and decryption work correctly. <DIV><PRE>&lt;&#37;&#64; Page Language="C#" &#37;&gt;<BR>&lt;script runat="server"&gt;<BR>&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; &#123;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Response.Write("Clear text connection string is: " &#43; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       ConfigurationManager.ConnectionStrings&#91;"MyLocalSQLServer"&#93;.ConnectionString);<BR>&nbsp;&nbsp;&nbsp; &#125;<BR>&lt;/script&gt;<BR>&lt;html&gt;<BR>&nbsp; &lt;body/&gt;<BR>&lt;/html&gt;  </PRE></DIV></LI></OL><P>MyLocalSQLServer is the name of the connection string you specified previously in the Web.config file. </P><HR><P>Adapted from Microsoft patterns &amp; practices guidance.</P>
]]></content></guidanceItem>